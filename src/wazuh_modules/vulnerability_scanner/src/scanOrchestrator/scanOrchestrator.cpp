/*
 * Wazuh Vulnerability scanner
 * Copyright (C) 2015, Wazuh Inc.
 * May 1, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "scanOrchestrator.hpp"

#include <iostream>

// TODO: Remove LCOV flags once the implementation of 'ScanOrchestrator' is completed
// LCOV_EXCL_START
void ScanOrchestrator::run(std::variant<const SyscollectorDeltas::Delta*,
                                        const SyscollectorSynchronization::SyncMsg*,
                                        std::shared_ptr<nlohmann::json>>& data)
{
    // Decoder, build context with builder pattern.
    try
    {
        // The scan only reads the content
        std::shared_lock<std::shared_mutex> lock(m_mutex);
        auto context = std::make_shared<ScanContext>(data);
        const auto type = context->getType();

        if (type == ScannerType::PackageInsert)
        {
            m_packageInsertOrchestration->handleRequest(std::move(context));
        }
        else if (type == ScannerType::PackageDelete)
        {
            m_packageDeleteOrchestration->handleRequest(std::move(context));
        }
        else if (type == ScannerType::HotfixInsert)
        {
            std::cout << "ScanOrchestrator::run::HotfixInserted" << std::endl;
        }
        else if (type == ScannerType::HotfixDelete)
        {
            std::cout << "ScanOrchestrator::run::HotfixDeleted" << std::endl;
        }
        else if (type == ScannerType::Os)
        {
            std::cout << "ScanOrchestrator::run::Os" << std::endl;
        }
        else if (type == ScannerType::IntegrityClear)
        {
            m_integrityClearOrchestration->handleRequest(std::move(context));
        }
        else if (type == ScannerType::DatabaseUpdate)
        {
            m_globalDatabaseFetchOrchestration->handleRequest(std::move(context));
        }
        else
        {
        }
    }
    catch (const std::exception& e)
    {
        logError(WM_VULNSCAN_LOGTAG, "ScanOrchestrator::run::Exception: %s", e.what());
    }
}
// LCOV_EXCL_STOP
